name: Verify Release Draft

on:
  release:
    types: [prereleased, edited]

jobs:
  verify-release:
    if: github.event.release.prerelease == true
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install requests
          
      - name: Save release body to file
        run: |
          cat << 'EOF' > /tmp/release_body.txt
          ${{ github.event.release.body }}
          EOF

      - name: Verify JIRA tickets
        id: verify
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python .github/workflows/scripts/verify_jira_tickets.py \
            --release-body-file /tmp/release_body.txt \
            --release-name "${{ github.event.release.name }}" \
            --release-url "${{ github.event.release.html_url }}"
        continue-on-error: true

      - name: Send test notification with all tickets
        if: always()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: ${{ secrets.TEST_NOTIFY_SLACK_CHANNEL }}
          payload: |
            {
              "text": "ğŸ“‹ ãƒªãƒªãƒ¼ã‚¹ãƒ‰ãƒ©ãƒ•ãƒˆæ¤œè¨¼ - ãƒã‚±ãƒƒãƒˆä¸€è¦§ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ğŸ“‹ *ãƒªãƒªãƒ¼ã‚¹ãƒ‰ãƒ©ãƒ•ãƒˆæ¤œè¨¼ - ãƒã‚±ãƒƒãƒˆä¸€è¦§ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰*\nãƒªãƒªãƒ¼ã‚¹: <${{ github.event.release.html_url }}|${{ github.event.release.name }}>"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‹ã‚‰æŠ½å‡ºã—ãŸãƒã‚±ãƒƒãƒˆ:*\n${{ steps.verify.outputs.all_release_list || '(ãªã—)' }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*JIRAã‹ã‚‰å–å¾—ã—ãŸãƒã‚±ãƒƒãƒˆ (Fix Version: ${{ steps.verify.outputs.fix_version }}):*\n${{ steps.verify.outputs.all_jira_list || '(ãªã—)' }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ãƒ‡ãƒãƒƒã‚°æƒ…å ±:*\nâ€¢ æ¤œè¨¼çµæœ: ${{ steps.verify.outcome }}\nâ€¢ Has Differences: ${{ steps.verify.outputs.has_differences }}\nâ€¢ Common Count: ${{ steps.verify.outputs.common_count }}"
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Send Slack notification on failure
        if: failure() && steps.verify.outcome == 'failure'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: ${{ secrets.TEST_NOTIFY_SLACK_CHANNEL }}
          payload: |
            {
              "text": "ğŸš¨ *ãƒªãƒªãƒ¼ã‚¹ãƒ‰ãƒ©ãƒ•ãƒˆæ¤œè¨¼ã‚¨ãƒ©ãƒ¼*",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ğŸš¨ *ãƒªãƒªãƒ¼ã‚¹ãƒ‰ãƒ©ãƒ•ãƒˆæ¤œè¨¼ã‚¨ãƒ©ãƒ¼*\nãƒªãƒªãƒ¼ã‚¹: <${{ github.event.release.html_url }}|${{ github.event.release.name }}>\n\nJIRAãƒªãƒ³ã‚¯ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€æ¤œè¨¼ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Generate Slack payload for differences
        if: steps.verify.outputs.has_differences == 'true'
        id: generate_payload
        run: |
          # Base payload
          PAYLOAD=$(cat <<EOF
          {
            "text": "ğŸ” ãƒªãƒªãƒ¼ã‚¹ãƒ‰ãƒ©ãƒ•ãƒˆæ¤œè¨¼çµæœ - å·®åˆ†ã‚ã‚Š",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "ğŸ” *ãƒªãƒªãƒ¼ã‚¹ãƒ‰ãƒ©ãƒ•ãƒˆæ¤œè¨¼çµæœ*\nãƒªãƒªãƒ¼ã‚¹: <${{ github.event.release.html_url }}|${{ github.event.release.name }}>"
                }
              }
          EOF
          )
          
          # Add only_in_release block if exists
          if [ -n "${{ steps.verify.outputs.only_in_release }}" ]; then
            PAYLOAD+=",
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"âš ï¸ *ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã®ã¿ã«å­˜åœ¨ã™ã‚‹ãƒã‚±ãƒƒãƒˆ:*\n${{ steps.verify.outputs.only_in_release_list }}\"
                }
              }"
          fi
          
          # Add only_in_jira block if exists
          if [ -n "${{ steps.verify.outputs.only_in_jira }}" ]; then
            PAYLOAD+=",
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"âŒ *JIRAã®ã¿ã«å­˜åœ¨ã™ã‚‹ãƒã‚±ãƒƒãƒˆ:*\n${{ steps.verify.outputs.only_in_jira_list }}\"
                }
              }"
          fi
          
          # Add common count block
          PAYLOAD+=",
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"ğŸ“Š å…±é€šã®ãƒã‚±ãƒƒãƒˆæ•°: ${{ steps.verify.outputs.common_count }}\"
                }
              }
            ]
          }"
          
          echo "$PAYLOAD" > slack_payload.json

      - name: Send Slack notification for differences
        if: steps.verify.outputs.has_differences == 'true'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: ${{ secrets.TEST_NOTIFY_SLACK_CHANNEL }}
          payload-file-path: slack_payload.json
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Send Slack notification for success
        if: steps.verify.outputs.has_differences == 'false' && steps.verify.outcome == 'success'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: ${{ secrets.TEST_NOTIFY_SLACK_CHANNEL }}
          payload: |
            {
              "text": "âœ… ãƒªãƒªãƒ¼ã‚¹ãƒ‰ãƒ©ãƒ•ãƒˆæ¤œè¨¼æˆåŠŸ",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "âœ… *ãƒªãƒªãƒ¼ã‚¹ãƒ‰ãƒ©ãƒ•ãƒˆæ¤œè¨¼æˆåŠŸ*\nãƒªãƒªãƒ¼ã‚¹: <${{ github.event.release.html_url }}|${{ github.event.release.name }}>\n\nãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã¨JIRAã®ãƒã‚±ãƒƒãƒˆã¯å®Œå…¨ã«ä¸€è‡´ã—ã¦ã„ã¾ã™ã€‚\nğŸ“Š ãƒã‚±ãƒƒãƒˆæ•°: ${{ steps.verify.outputs.common_count }}"
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
